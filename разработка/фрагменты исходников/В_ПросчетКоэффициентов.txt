
Процедура РаспределениеОбработкаСезонныхКоэффициентов (ПоВсейНоменклатуре,ВыбраннаяНоменклатура, ГодПроверки) Экспорт 
	
	
	
	Если
		ПоВсейНоменклатуре = Истина 
		Тогда 
		
		
			
		
		
 		Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Номенклатура.Наименование
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура 
	    |ГДЕ
		|   НЕ Номенклатура.ЭтоГруппа";
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл  
		// обращение к функции расчёта коэффициентов 
		// по каждому элементу из справочнике Номенклатура 
		ОбработкаСезонныхКоэффициентов(ВыборкаДетальныеЗаписи.Получить(0),ГодПроверки);
	КонецЦикла;
	
	
	
	
	 
		Иначе 
          // обращение к функции расчёта коэффициентов 
		  // по выбранной номенклатуре
			ОбработкаСезонныхКоэффициентов(ВыбраннаяНоменклатура,ГодПроверки);

		
		КонецЕсли;
	
	
	КонецПроцедуры





процедура ОбработкаСезонныхКоэффициентов (ВыбраннаяНоменклатура, ГодПроверки)       
	
// генерация начала и конца расчётного переиода
КонецТекущегоГода =  КонецГода( ГодПроверки);
НачалоТекущегоГода =  НачалоГода(ГодПроверки);


// запрос в базу для получения необходимой информации 	
Нуль = 0;
Сообщить(ВыбраннаяНоменклатура);


	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ПродажиОбороты.КоличествоОборот,
		|	ПродажиОбороты.Период
		|ИЗ
		|	РегистрНакопления.Продажи.Обороты(&НачалоТекущегоГода, &КонецТекущегоГода, День, Номенклатура.Наименование = &ВыбраннаяНоменклатура) КАК ПродажиОбороты
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ОстаткиНоменклатуры.Обороты(&НачалоТекущегоГода, &КонецТекущегоГода, День, Номенклатура.Наименование = &ВыбраннаяНоменклатура) КАК ОстаткиНоменклатурыОбороты
		|		ПО ПродажиОбороты.Период = ОстаткиНоменклатурыОбороты.Период
		|ГДЕ
		|	ОстаткиНоменклатурыОбороты.КоличествоОборот <> &Нуль";
	
	Запрос.УстановитьПараметр("ВыбраннаяНоменклатура", ВыбраннаяНоменклатура);
	Запрос.УстановитьПараметр("КонецТекущегоГода", КонецТекущегоГода);
	Запрос.УстановитьПараметр("НачалоТекущегоГода", НачалоТекущегоГода);
	Запрос.УстановитьПараметр("Нуль", Нуль);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	
	
	
	
	// обработка полученных результатов
	
	
	//// вычисление сезонных коэффициентов для каждого из периодов, созданных пользователем
	
	   	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	В_ИнформацияОСезонности.Наименование,
		|	В_ИнформацияОСезонности.ДатаНачала,
		|	В_ИнформацияОСезонности.ДатаОкончания
		|ИЗ
		|	Справочник.В_ИнформацияОСезонности КАК В_ИнформацияОСезонности
		|ГДЕ
		|	НЕ В_ИнформацияОСезонности.ЭтоГруппа";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписиСезоны = РезультатЗапроса.Выбрать();
	
			  /////////////////////////////////////////////
			  
			  // получение среднегодового потребления выбранной номенклтуры
			  СреднееСумма = 0; СреднееКоличество = ВыборкаДетальныеЗаписи.Количество();
			  Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
				  СреднееСумма = СреднееСумма + ВыборкаДетальныеЗаписи.Получить(0);
		КонецЦикла;
	
			Если ВыборкаДетальныеЗаписи.Количество() <> 0 Тогда 	СреднееПотребление =  СреднееСумма / СреднееКоличество           КонецЕсли;
			  
			
			///////////////////////////////////////////////
			
	        //обработка по каждому созданному сезону
	     Пока ВыборкаДетальныеЗаписиСезоны.Следующий() Цикл
			 
			 
			 
			    //нахождение суммы проданных товаров за обрабатываемый сезон
			  ПотреблениеЗаТекСезон = 0; КолВоЗаТекСезон = 0;			
			  Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
				  Если ВыборкаДетальныеЗаписи.Получить(1) > ВыборкаДетальныеЗаписиСезоны.Получить(1) И 
				        ВыборкаДетальныеЗаписи.Получить(1) < ВыборкаДетальныеЗаписиСезоны.Получить(2)
						
			  Тогда 
			 ПотреблениеЗаТекСезон = ПотреблениеЗаТекСезон + ВыборкаДетальныеЗаписи.Получить(0);  КолВоЗаТекСезон = КолВоЗаТекСезон +1;
			  КонецЕсли;
			  
					КонецЦикла;
	
	
	
	
	                  // сам сезонный коэффициент за обрабатываемый сезон
					  
                     Если ПотреблениеЗаТекСезон <> 0 и КолВоЗаТекСезон <> 0 Тогда   СезонныйКоэф = ПотреблениеЗаТекСезон  / (СреднееПотребление * КолВоЗаТекСезон);
	                      КонецЕсли;
	
	                        Сообщить("сезонный коэффициент за " + ВыборкаДетальныеЗаписиСезоны.Получить(0) + " = " + СезонныйКоэф + "//" + ПотреблениеЗаТекСезон + "@" + СреднееПотребление + "&&&" + КолВоЗаТекСезон); 
							
							
							
	                        // отправка готового сезонного коэффициента по табличным частям документов и в регистр сведений
	                       выбратьСправочникСезон =   Справочники.В_ИнформацияОСезонности.НайтиПоНаименованию(ВыборкаДетальныеЗаписиСезоны.Получить(0)).ПолучитьОбъект(); 
						   
						   
	                                НоваяСтрока = выбратьСправочникСезон.Коэффициенты.Добавить();
	
	                                      НоваяСтрока.Номенклатура = ВыбраннаяНоменклатура;
										  НоваяСтрока.коеффициент = СезонныйКоэф;
										  НоваяСтрока.ДатаПроверки = ТекущаяДата();
										  выбратьСправочникСезон.Записать();
										  
										  
										  
										  
										  
										  
			ЗаписатьВРегистр = РегистрыСведений.СезонныеКоэффициенты.СоздатьМенеджерЗаписи();
			
				ЗаписатьВРегистр.Коэффициент = 	СезонныйКоэф;
				    ЗаписатьВРегистр.Товар = Справочники.Номенклатура.НайтиПоНаименованию( ВыбраннаяНоменклатура); 
					ЗаписатьВРегистр.Период = ТекущаяДата();
					   ЗаписатьВРегистр.Записать(Истина);
										  
										  
										  
	                   ЗаписьВРегистр =  РегистрыСведений.В_СезонныеКоэффициенты.СоздатьМенеджерЗаписи();
					   ЗаписьВРегистр.Сезон = Справочники.В_ИнформацияОСезонности.НайтиПоНаименованию(ВыборкаДетальныеЗаписиСезоны.Получить(0)).Ссылка;   
	                   ЗаписьВРегистр.Номенклатура = Справочники.Номенклатура.НайтиПоНаименованию( ВыбраннаяНоменклатура);   
					   ЗаписьВРегистр.СезонныйКоеффициент = СезонныйКоэф; 
					   ЗаписьВРегистр.дата = ТекущаяДата(); 
	                   ЗаписьВРегистр.Период = ТекущаяДата();
					      
						  
					  ЗаписьВРегистр.Записать(Истина);
	                  	
	
	    // перезарядка алгоритма просмотра доступных сведений о продажах
	ВыборкаДетальныеЗаписи.Сбросить()
	
	   КонецЦикла;

	
	   
	   
	   
	   
	
	            Сообщить("конец обработки номенклатуры: " + ВыбраннаяНоменклатура);
	 	
КонецПроцедуры